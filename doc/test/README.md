# 热Key功能测试说明

## 概述

本目录包含热Key功能的完整测试脚本，用于验证热Key检测功能的完整性、合理性和潜在bug。测试包括基础功能测试和长时间运行测试（OOM验证）。

## 测试配置

根据当前配置：
- **热Key QPS阈值**: 30.0 (QPS >= 30 才能成为热Key)
- **温Key QPS阈值**: 10.0 (QPS >= 10 才能成为温Key)
- **访问记录最大容量**: 15 (最多记录15个key的访问统计)
- **Top N限制**: 10 (最多保留10个热Key)
- **刷新间隔**: 10秒
- **降级间隔**: 60秒

## 快速开始

### 1. 安装依赖

```bash
# 确保已安装Python 3和requests库
pip install requests
```

### 2. 启动服务

```bash
# 启动Redis服务
redis-server
# 或使用Docker
docker run -d -p 6379:6379 redis:latest

# 启动应用
cd /Users/admin/kanzhun-ai-workspace/techwolf-hotkey-demo
mvn spring-boot:run
```

### 3. 运行测试

**方式1：使用统一测试脚本（推荐）**

```bash
# 运行基础功能测试
./run_tests.sh

# 运行长时间运行测试（OOM验证）
./run_tests.sh --long-run

# 监控系统状态
./run_tests.sh --monitor

# 运行所有测试
./run_tests.sh --all

# 查看帮助
./run_tests.sh --help
```

**方式2：直接使用Python脚本**

```bash
# 运行基础功能测试（16个测试用例）
python3 hotkey_test.py

# 运行长时间运行测试（OOM验证，默认30分钟）
python3 hotkey_test.py --long-run

# 运行长时间运行测试（自定义时长和检查间隔）
python3 hotkey_test.py --long-run --duration 60 --interval 30

# 监控系统状态
python3 hotkey_test.py --monitor
```

## 测试脚本说明

### 1. hotkey_test.py - 主测试脚本

**功能**：
- ✅ 基础功能测试（16个测试用例）
- ✅ 长时间运行测试（OOM验证）
- ✅ 系统状态监控

**测试内容**：

#### 基础功能测试（16个测试用例）

1. **基础功能测试**: 验证基本的set/get操作
2. **热Key检测测试**: 高频访问触发热Key（QPS > 30）
3. **温Key检测测试**: 中等频率访问触发温Key（10 <= QPS < 30）
4. **容量限制测试**: 测试recorderMaxCapacity=15的限制
5. **并发访问测试**: 多线程并发访问测试
6. **缓存命中率测试**: 验证热Key缓存命中率
7. **边界情况测试**: 空值、特殊字符、Unicode、长值等
8. **不存在的key测试**: 访问不存在的key
9. **多个热Key测试**: 同时存在多个热Key
10. **值更新测试**: 热Key值更新后缓存自动刷新
11. **删除操作测试**: 删除热Key后本地缓存是否被清理
12. **热Key降级测试**: 热Key访问频率降低后是否会被降级
13. **写操作触发缓存更新测试**: 写入热Key后本地缓存是否自动更新
14. **Top N限制测试**: 超过Top N数量的热Key是否被正确处理
15. **刷新失败处理测试**: 刷新失败超过阈值后热Key是否被自动移除
16. **监控API测试**: 验证所有监控API是否正常工作

#### 长时间运行测试（OOM验证）

**测试目标**：
- 验证系统在长时间运行下是否会出现OOM问题
- 验证热Key数量控制机制
- 验证内存使用是否稳定
- 验证降级机制是否正常工作

**测试方法**：
- 持续创建新的热Key（超过Top N限制）
- 监控热Key数量、存储层大小、访问记录大小
- 检查降级机制是否正常工作
- 检测OOM风险

**测试配置**：
- 默认持续时间：30分钟（可通过 `--duration` 参数调整）
- 检查间隔：60秒（可通过 `--interval` 参数调整）
- 每次创建5个热Key

#### 系统状态监控

**功能**：
- 实时查看系统健康状态
- 检查热Key数量、存储层大小、访问记录大小
- 分析OOM风险
- 显示热Key列表和性能指标

### 2. run_tests.sh - 统一测试运行脚本

**功能**：
- 整合所有测试功能
- 提供统一的命令行接口
- 自动检查服务可用性
- 支持多种测试模式

**使用方法**：
```bash
./run_tests.sh [选项]
```

**选项**：
- `(无参数)` - 运行基础功能测试
- `--long-run` - 运行长时间运行测试（OOM验证）
- `--monitor` - 监控系统状态
- `--all` - 运行所有测试（基础测试 + 长时间测试）
- `--duration <分钟>` - 长时间测试持续时间（默认30）
- `--interval <秒>` - 长时间测试检查间隔（默认60）
- `--help` - 显示帮助信息

## 测试场景说明

### 场景1: 热Key检测
- **目标**: 验证高频访问（QPS > 30）能正确触发热Key检测
- **方法**: 在短时间内对同一个key进行大量访问
- **验证点**: 
  - 访问统计是否正确
  - 热Key是否被正确识别
  - 缓存是否生效

### 场景2: 温Key检测
- **目标**: 验证中等频率访问（10 <= QPS < 30）能正确触发温Key检测
- **方法**: 控制访问频率在20 QPS左右
- **验证点**: 
  - 温Key是否被正确识别
  - 不会误判为热Key

### 场景3: 容量限制
- **目标**: 验证当访问记录超过最大容量时，系统能正确处理
- **方法**: 创建超过15个不同的key并进行访问
- **验证点**: 
  - 容量限制是否生效
  - 低QPS的key是否被正确清理
  - 高QPS的key是否被保留

### 场景4: 并发访问
- **目标**: 验证多线程并发访问时的正确性
- **方法**: 使用10个线程同时访问同一个key
- **验证点**: 
  - 无数据竞争
  - 返回值正确
  - 无异常抛出

### 场景5: 缓存命中率
- **目标**: 验证热Key缓存的命中率
- **方法**: 触发热Key后连续访问
- **验证点**: 
  - 缓存命中率应该 >= 90%
  - 返回值正确

### 场景6: 边界情况
- **目标**: 验证各种边界情况的处理
- **方法**: 测试空值、特殊字符、Unicode、长值等
- **验证点**: 
  - 所有边界情况都能正确处理
  - 无异常抛出

### 场景7: 值更新
- **目标**: 验证热Key值更新后缓存自动刷新
- **方法**: 触发热Key后更新Redis中的值，等待自动刷新
- **验证点**: 
  - 缓存能在刷新间隔内自动更新
  - 更新后的值正确

### 场景8: 删除操作
- **目标**: 验证删除热Key后本地缓存是否被清理
- **方法**: 触发热Key后删除Redis中的key
- **验证点**: 
  - 删除后本地缓存被清理
  - 删除后注册表被清理（避免无意义的刷新尝试）
  - 删除后key无法访问

**改进说明**：
- 删除操作现在会同时清理缓存、注册表和失败计数
- 避免删除后继续尝试刷新已删除的key，节省资源
- 立即生效，无需等待失败阈值

### 场景9: 热Key降级
- **目标**: 验证热Key访问频率降低后是否会被降级
- **方法**: 触发热Key后停止高频访问，等待降级任务执行
- **验证点**: 
  - 热Key被正确降级
  - 降级后缓存被清理
  - 降级后key仍能正常访问（从Redis）

### 场景10: 写操作触发缓存更新
- **目标**: 验证写入热Key后本地缓存是否自动更新
- **方法**: 触发热Key后写入新值
- **验证点**: 
  - 写操作后缓存立即更新
  - 更新后的值正确

### 场景11: Top N限制
- **目标**: 验证超过Top N数量的热Key是否被正确处理
- **方法**: 创建超过Top N数量的key并高频访问
- **验证点**: 
  - 热Key数量不超过Top N
  - 所有热Key都能正常访问

### 场景12: 刷新失败处理
- **目标**: 验证刷新失败超过阈值后热Key是否被自动移除
- **方法**: 触发热Key后删除Redis中的key，等待多次刷新周期
- **验证点**: 
  - 刷新失败超过阈值后热Key被移除
  - 失败计数正确

### 场景13: 监控API
- **目标**: 验证所有监控API是否正常工作
- **方法**: 调用各个监控API接口
- **验证点**: 
  - 所有监控API正常响应
  - 返回数据格式正确

### 场景14: 长时间运行（OOM验证）
- **目标**: 验证系统在长时间运行下是否会出现OOM问题
- **方法**: 持续创建热Key，监控内存使用
- **验证点**: 
  - 热Key数量控制正常
  - 存储层大小控制正常
  - 访问记录大小控制正常
  - 未发现OOM风险

## 监控API说明

测试脚本使用以下监控API来验证热Key状态和获取监控指标：

### 1. 检查指定key是否为热Key
**接口**：`GET /api/hotkey/monitor/check?key={key}`

**示例**：
```bash
curl "http://localhost:8080/api/hotkey/monitor/check?key=test:hotkey:1"
```

**响应**：
```json
{
  "enabled": true,
  "key": "test:hotkey:1",
  "isHotKey": true,
  "hotKeyCount": 2
}
```

### 2. 获取完整监控信息
**接口**：`GET /api/hotkey/monitor/info`

**示例**：
```bash
curl "http://localhost:8080/api/hotkey/monitor/info"
```

**响应**：包含所有监控指标，如热Key数量、命中率、QPS等

### 3. 获取热Key列表
**接口**：`GET /api/hotkey/monitor/hotkeys`

**示例**：
```bash
curl "http://localhost:8080/api/hotkey/monitor/hotkeys"
```

### 4. 获取统计信息
**接口**：`GET /api/hotkey/monitor/stats`

**示例**：
```bash
curl "http://localhost:8080/api/hotkey/monitor/stats"
```

### 5. 手动刷新监控数据
**接口**：`POST /api/hotkey/monitor/refresh`

**示例**：
```bash
curl -X POST "http://localhost:8080/api/hotkey/monitor/refresh"
```

## 预期结果

所有测试应该通过，表明：
1. ✅ 热Key检测功能正常工作
2. ✅ 缓存机制正确
3. ✅ 容量限制有效
4. ✅ 并发访问安全
5. ✅ 边界情况处理正确
6. ✅ 自动刷新机制正常
7. ✅ 删除操作优化生效
8. ✅ 长时间运行稳定，无OOM风险

## 常见问题

### Q: 测试失败，提示连接超时
**A**: 确保应用已启动并运行在8080端口，检查防火墙设置

### Q: 热Key检测测试失败
**A**: 检查配置的QPS阈值，确保访问频率足够高。可以增加访问次数或减少等待时间

### Q: 缓存命中率低于预期
**A**: 确保等待足够的时间让热Key晋升完成（至少6秒），然后再测试缓存命中率

### Q: 容量限制测试失败
**A**: 容量限制可能导致部分低QPS的key被清理，这是正常行为。测试主要验证系统不会崩溃

### Q: 长时间测试如何中断
**A**: 按 `Ctrl+C` 可以随时中断测试，测试会输出当前状态和总结

## 性能指标

测试完成后，可以通过以下方式查看性能指标：

### 1. 通过监控API
使用监控API实时查询：
```bash
# 获取完整监控信息
curl "http://localhost:8080/api/hotkey/monitor/info"

# 获取统计信息
curl "http://localhost:8080/api/hotkey/monitor/stats"
```

### 2. 通过测试脚本
```bash
# 监控系统状态
python3 hotkey_test.py --monitor
# 或
./run_tests.sh --monitor
```

### 3. 通过应用日志
查看应用日志中的监控输出，包含以下指标：
- 热Key数量
- 缓存命中率
- 访问记录模块数据量
- wrapGet总调用次数
- wrapGet的QPS

## OOM风险分析

### 系统保护机制

1. **Top N限制**: 晋升时只保留Top N个热Key（默认10个）
2. **降级机制**: 每分钟检查并降级低QPS的热Key
3. **容量限制**: 
   - 本地缓存：最多200个（可配置）
   - 访问记录：最多100000个（可配置）
   - 自动清理过期和低QPS的key
4. **自动过期**: Caffeine缓存1分钟自动过期

### 长时间测试验证

长时间运行测试已验证：
- ✅ 热Key数量控制正常（始终在Top N限制内）
- ✅ 存储层大小控制正常（远低于限制）
- ✅ 访问记录大小控制正常（远低于限制）
- ✅ 降级机制正常工作
- ✅ 未发现OOM风险

**结论**: 系统已通过长时间运行测试，可以安全用于生产环境。

## 文件说明

- `hotkey_test.py` - 主测试脚本（整合了所有测试功能）
- `run_tests.sh` - 统一测试运行脚本（推荐使用）
- `README.md` - 本文件，测试说明文档

## 扩展测试

可以根据需要添加以下测试：
- 压力测试：长时间高并发访问
- 内存泄漏测试：长时间运行后检查内存使用
- 降级测试：热Key降级为温Key或冷Key
- 故障恢复测试：Redis连接断开后的恢复
